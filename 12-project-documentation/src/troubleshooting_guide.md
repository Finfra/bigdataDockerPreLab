# FMS BigData Pipeline 트러블슈팅 가이드

## 일반적인 문제 및 해결방안

### 데이터 수집 관련 이슈
| 문제 | 증상 | 원인 | 해결방안 | 예방책 |
|------|------|------|----------|--------|
| API 응답 지연 | 수집 간격 불규칙 | 네트워크 지연, 서버 과부하 | Timeout 설정(10초), 재시도 로직 | API 헬스체크 강화 |
| 데이터 누락 | 메시지 수 불일치 | API 에러, 네트워크 단절 | Circuit Breaker 적용 | 모니터링 알림 설정 |
| 잘못된 데이터 | 센서값 범위 초과 | 센서 오작동, 전송 오류 | 데이터 검증 강화 | 데이터 품질 모니터링 |

### Kafka 관련 이슈  
| 문제 | 증상 | 원인 | 해결방안 | 예방책 |
|------|------|------|----------|--------|
| 파티션 불균형 | 특정 파티션 과부하 | 키 분산 불균등 | 파티셔닝 전략 변경 | 파티션별 메트릭 모니터링 |
| 컨슈머 지연 | 메시지 처리 지연 | 처리 성능 부족 | 컨슈머 병렬도 증가 | 처리량 모니터링 |
| 브로커 다운 | 메시지 전송 실패 | 하드웨어/소프트웨어 장애 | 자동 장애조치 설정 | 클러스터 헬스 모니터링 |

### Spark 관련 이슈
| 문제 | 증상 | 원인 | 해결방안 | 예방책 |
|------|------|------|----------|--------|
| OutOfMemory | 작업 실패 | 메모리 부족 | 메모리 할당 증가 | 리소스 사용률 모니터링 |
| 배치 처리 지연 | 실시간성 저하 | 데이터량 증가 | 배치 크기 조정 | 처리 지연시간 모니터링 |
| 체크포인트 실패 | 재시작 시 데이터 손실 | 스토리지 문제 | 체크포인트 경로 변경 | 백업 체크포인트 설정 |

### HDFS 관련 이슈
| 문제 | 증상 | 원인 | 해결방안 | 예방책 |
|------|------|------|----------|--------|
| 소용량 파일 다량 생성 | NameNode 부하 | 빈번한 쓰기 작업 | 배치 단위 증가 | 파일 병합 스케줄링 |
| DataNode 장애 | 복제본 부족 | 하드웨어 장애 | 자동 복제본 생성 | 디스크 상태 모니터링 |
| 디스크 공간 부족 | 쓰기 실패 | 용량 부족 | 오래된 파일 정리 | 용량 사용률 알림 |

## 응급 대응 절차

### 시스템 전체 장애 시
1. **즉시 대응**
   - 모든 서비스 상태 확인: `docker-compose ps`
   - 로그 확인: `docker-compose logs -f [service_name]`
   - 헬스체크 실행: `./scripts/cluster-health-check.sh`

2. **서비스 재시작**
   ```bash
   # 개별 서비스 재시작
   docker-compose restart [service_name]
   
   # 전체 시스템 재시작  
   docker-compose down
   docker-compose up -d
   ```

3. **데이터 무결성 확인**
   - Kafka 토픽 메시지 수 확인
   - HDFS 파일 개수 및 크기 확인
   - 최근 체크포인트 상태 확인

### 데이터 손실 발생 시
1. **손실 범위 파악**
   ```bash
   # 최근 데이터 확인
   docker exec fms-namenode hdfs dfs -ls /fms/processed/
   
   # Kafka 오프셋 확인
   docker exec fms-kafka-1 kafka-consumer-groups --bootstrap-server kafka-1:9092 --describe --all-groups
   ```

2. **복구 작업**
   - 체크포인트에서 Spark 작업 재시작
   - 백업 데이터에서 복원
   - 필요시 API에서 데이터 재수집

## 모니터링 및 알림 설정

### 핵심 모니터링 지표
- **데이터 수집률**: 분당 수집 메시지 수
- **처리 지연시간**: 수집 → 저장 완료 시간
- **에러율**: 전체 대비 에러 발생 비율
- **리소스 사용률**: CPU, 메모리, 디스크 사용률

### 알림 임계값
- **CRITICAL**: 에러율 > 10%, 지연시간 > 60초
- **WARNING**: 에러율 > 5%, 지연시간 > 30초
- **INFO**: 정상 범위 내 변동